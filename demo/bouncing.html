<link href="./common.css" rel="stylesheet" />
<style>
#game-container {
	width: 100%;
	height: 600px;
	background-color: beige;
	outline: 1px solid blue;
	position: relative;
	display: flex;
}
.board {
	flex: 1;
}
.paddle {
	width: 15px;
	background-color: black;
	position: absolute;
}
.left {
	left: 10px;
}
.right {
	right: 10px;
}
</style>
<script src="../dist/gimgen.js"></script>
<script src="https://rawgit.com/Matt-Esch/virtual-dom/master/dist/virtual-dom.js"></script>

<main>
	<p>
		Use <kbd>Q<kbd> and <kbd>W</kbd> to move the left paddle and <kbd>O<kbd> and <kbd>P</kbd> to move the right paddle
	</p>
	<p>
		See code below (or even better look at <a href="https://github.com/togakangaroo/gimgen/blob/master/demo/bouncing.html">source</a> or devtools)
	</p>
	<section id="game-container">
	</section>
	<pre><code class="language-js" id="code-display"></code></pre>
</main>

<script id="code">
const { gimgen: {gimgen, runGimgen, timeoutSignal, domEventToSignal, anySignal, controlSignal, createSignal} } = window
const { virtualDom: {h, diff, patch, create} } = window
const container = document.querySelector('#game-container')
const containerHeight = container.offsetHeight

const clone = x => Object.assign({}, x)
const clamp = (v, min, max) => v < min ? min : v > max ? max : v
const pick = (obj, ...props) => props.reduce((x, p) => (x[p] = obj[p], x), {})

const state = {
	leftPaddle: { top: containerHeight/2 - 35, height: 70, speed: 8 },
	rightPaddle: { top: containerHeight/2 - 35, height: 70, speed: 8 },
}

const render = ({
	leftPaddle, rightPaddle,
}) =>
	h('.board', [
		h('.paddle.left', {style: pick(leftPaddle, 'top', 'height') }), //must be a new object reference for diffing to work
		h('.paddle.right', {style: pick(rightPaddle, 'top', 'height') }),
	])

//Create our own signal that will trigger on next animation frame
const requestAnimationFrame = createSignal('requestAnimationFrame', () =>
	//the second parameter is the createPromise function which will be called on yield and simply generates
	//a promise whose resolution tells gimgen to finish yielding
	new Promise(resolve => window.requestAnimationFrame(resolve))
)() //We just need a single instance so invoke the signal factory
runGimgen(function*() {
	const tick = timeoutSignal(50)
	let tree = render(state)
	let rootNode = create(tree)
	container.appendChild(rootNode)

	while(true) {
		yield tick
		yield requestAnimationFrame
		const newTree = render(state) //virtual-dom stuff
		patch(rootNode, diff(tree, newTree))
		tree = newTree
	}
}	)

const keysDown = controlSignal(function*({emit}) {
	const keydown = domEventToSignal(document, 'keydown')
	const keyup = domEventToSignal(document, 'keyup')
	const currentlyPressed = {}
	let interaction
	while(interaction = yield anySignal(keydown, keyup)) {
		currentlyPressed[interaction.getLastEvent().code] = (keydown === interaction)
		emit(currentlyPressed)
	}
})

const movePaddle = gimgen(function*(paddle, up, down){
	while(true) {
		const keysPressed = yield keysDown
		if(keysPressed[up])
			paddle.top -= paddle.speed;
		else if(keysPressed[down])
			paddle.top += paddle.speed;
		paddle.top = clamp(paddle.top, 0, containerHeight - paddle.height)
	}
})

movePaddle(state.leftPaddle, 'KeyQ', 'KeyW')
movePaddle(state.rightPaddle, 'KeyO', 'KeyP')
</script>
<script>
document.querySelector('#code-display').textContent = document.querySelector('#code').textContent;
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.4.1/prism.min.js" defer></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.4.1/themes/prism.min.css" rel="stylesheet" />
